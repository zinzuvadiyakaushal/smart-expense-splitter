{% extends 'base.html' %}

{% block title %}Dashboard Â· Smart Expense Splitter{% endblock %}

{% block content %}
<section class="mb-5 insights-section">
    <div class="row align-items-center">
        <div class="col-lg-7">
            <h1 class="display-5 fw-bold">Track, Split and Settle in seconds</h1>
            <p class="lead text-white-50">Split expenses with your group members effortlessly. Track shared costs, add expenses, and see who needs to pay whom automatically.</p>
            <div class="d-flex gap-3 flex-wrap">
                <a href="{% url 'create_group' %}" class="btn btn-gradient btn-lg">Create New Group</a>
                {% if first_group_id %}
                    <a href="{% url 'balance_summary' first_group_id %}" class="btn btn-outline-light btn-lg">View Balances</a>
                {% else %}
                    <button class="btn btn-outline-light btn-lg" disabled>View Balances</button>
                {% endif %}
            </div>
        </div>
        <div class="col-lg-5 mt-4 mt-lg-0">
            <div class="card card-glass h-100 shadow border-0">
                <div class="card-body d-flex flex-column p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0 fw-semibold">Insights</h5>
                        <span class="chip">Overview</span>
                    </div>
                    <div class="row g-3 mt-auto">
                        <div class="col-6">
                        <div class="card card-glass p-3 text-center h-100">
                            <p class="text-white-50 mb-1 small">Groups</p>
                            <h2 class="fw-bold mb-0 text-white counter">{{ groups|length }}</h2>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card card-glass p-3 text-center h-100">
                            <p class="text-white-50 mb-1 small">Members</p>
                            <h2 class="fw-bold mb-0 text-white counter">{{ total_members }}</h2>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card card-glass p-3 text-center h-100">
                            <p class="text-white-50 mb-1 small">Total Logged</p>
                            <h3 class="fw-bold mb-0 text-white">â‚¹<span class="counter">{{ total_amount|floatformat:0 }}</span></h3>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card card-glass p-3 text-center h-100">
                            <p class="text-white-50 mb-1 small">Pending Split</p>
                            <h3 class="fw-bold mb-0 text-white">â‚¹<span class="counter">{{ pending_amount|floatformat:0 }}</span></h3>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="active-groups-section">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h4">Your Active Groups</h2>
        <a href="{% url 'create_group' %}" class="btn btn-outline-light btn-sm">+ New Group</a>
    </div>
    {% if group_cards %}
        <div class="row g-4">
            {% for card in group_cards %}
                {% with group=card.group %}
                <div class="col-md-6 col-xl-4">
                    <div class="card card-glass h-100 shadow border-0">
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="mb-0 fw-semibold">{{ group.name }}</h5>
                                <span class="badge bg-primary bg-opacity-25 text-white">Members: {{ group.members.count }}</span>
                            </div>
                            <p class="text-white-50 mb-2">Total spend: â‚¹{{ card.total|floatformat:2 }}</p>
                            <div class="d-flex align-items-center gap-3 mb-4">
                                <div class="progress-ring" style="--progress: {{ card.percent }}%;" data-label="{{ card.percent|floatformat:0 }}%"></div>
                                <div>
                                    <p class="text-white-50 mb-1 small">Created {{ group.created_date|date:"M d, Y" }}</p>
                                    {% if card.latest_expense %}
                                        <p class="text-white mb-0 small">Latest: {{ card.latest_expense.title }}</p>
                                    {% else %}
                                        <p class="text-white mb-0 small">Latest: No expense yet</p>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="mt-auto d-flex gap-2">
                                <a href="{% url 'group_detail' group.id %}" class="btn btn-gradient flex-fill">View Group</a>
                                <a href="{% url 'balance_summary' group.id %}" class="btn btn-outline-light flex-fill">Balances</a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endwith %}
            {% endfor %}
        </div>
    {% else %}
        <div class="card card-glass p-4">
            <h4 class="fw-semibold">No groups yet</h4>
            <p class="text-white-50">Start by creating a group for your roommates, travel buddies, or any team you share expenses with.</p>
            <a href="{% url 'create_group' %}" class="btn btn-gradient">Create your first group</a>
        </div>
    {% endif %}
</section>

<section class="mt-5 row g-4">
    <div class="col-lg-6 recent-activity-section">
        <div class="card card-glass h-100 shadow border-0">
            <div class="card-body d-flex flex-column p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <p class="text-uppercase text-white-50 mb-1 small">Recent activity</p>
                        <h5 class="mb-0 fw-semibold">Live expense radar</h5>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="chip" id="activity-status">Synced</span>
                        <button class="btn btn-sm btn-outline-light" onclick="refreshActivity()" title="Refresh">
                            <span id="refresh-icon">â†»</span>
                        </button>
                    </div>
                </div>
                <div id="recent-activity-content">
                    {% if recent_expenses %}
                        <div class="timeline mt-auto">
                            {% for expense in recent_expenses %}
                                <div class="timeline-item">
                                    <span class="timeline-dot"></span>
                                    <div class="ms-4 d-flex justify-content-between gap-3 flex-wrap">
                                        <div>
                                            <h5 class="mb-1 text-white">{{ expense.title }}</h5>
                                            <p class="text-white-50 mb-0 small">
                                                {{ expense.group.name }} Â· {{ expense.date|date:"d M, H:i" }}
                                            </p>
                                        </div>
                                        <span class="chip">â‚¹{{ expense.amount }}</span>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state text-center py-4 mt-auto">
                            <h5 class="text-white mb-1">Nothing yet</h5>
                            <p class="text-white-50 mb-0">Add your first expense to populate the radar.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6 smart-suggestions-section">
        <div class="card card-glass h-100 shadow border-0">
            <div class="card-body d-flex flex-column p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <p class="text-uppercase text-white-50 mb-1 small">Smart suggestions</p>
                        <h5 class="mb-0 fw-semibold">Ready to settle</h5>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="chip">Smart AI</span>
                        <button class="btn btn-sm btn-outline-light" onclick="refreshSuggestions()" title="Refresh">
                            <span id="suggestions-refresh-icon">â†»</span>
                        </button>
                    </div>
                </div>
                <div id="smart-suggestions-content">
                    {% if pending_cards %}
                        <div class="suggestion-stack d-grid gap-3 mt-auto">
                            {% for card in pending_cards %}
                                {% with group=card.group balances=card.balances %}
                                    <div class="suggestion-card p-3 rounded-4 border border-light border-opacity-25 d-flex flex-wrap justify-content-between align-items-center">
                                        <div>
                                            <h5 class="mb-1 text-white">{{ group.name }}</h5>
                                            <p class="text-white-50 mb-0 small">{{ balances|length }} pending splits Â· â‚¹{{ card.total|floatformat:2 }}</p>
                                        </div>
                                        <a href="{% url 'balance_summary' group.id %}" class="btn btn-outline-light btn-sm rounded-pill px-3">Review</a>
                                    </div>
                                {% endwith %}
                            {% empty %}
                                <p class="text-white-50 mb-0">All groups are balanced.</p>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center text-white-50 py-4 mt-auto">
                            <h4 class="text-white">All settled ðŸŽ‰</h4>
                            <p class="mb-0">Great job keeping everyone paid up.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<div class="floating-action-container">
    <a class="floating-action" href="{% url 'create_group' %}" title="Create New Group" aria-label="Create New Group">
        <div class="floating-particles">
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
        </div>
    </a>
</div>

<script>
    // Professional counter animation
    function animateCounter(element, target) {
        let current = 0;
        const increment = target / 50;
        const timer = setInterval(() => {
            current += increment;
            if (current >= target) {
                element.textContent = target.toLocaleString();
                clearInterval(timer);
            } else {
                element.textContent = Math.floor(current).toLocaleString();
            }
        }, 30);
    }

    // Initialize counters on page load
    document.addEventListener('DOMContentLoaded', function() {
        const counters = document.querySelectorAll('.counter');
        counters.forEach(counter => {
            const target = parseInt(counter.textContent.replace(/,/g, ''));
            animateCounter(counter, target);
        });

        // Add floating animation to cards
        const cards = document.querySelectorAll('.card-glass');
        cards.forEach((card, index) => {
            card.style.animationDelay = `${index * 0.1}s`;
            card.classList.add('floating-element');
        });
    });

    // Enhanced refresh functions with loading states
    function refreshActivity() {
        const button = document.querySelector('[onclick="refreshActivity()"]');
        const icon = document.getElementById('refresh-icon');
        const status = document.getElementById('activity-status');

        button.classList.add('btn-loading');
        button.disabled = true;
        icon.style.animation = 'spin 0.5s linear';
        status.textContent = 'Updating...';

        // Reload the page to get fresh data
        setTimeout(() => {
            window.location.reload();
        }, 500);
    }

    function refreshSuggestions() {
        const button = document.querySelector('[onclick="refreshSuggestions()"]');
        const icon = document.getElementById('suggestions-refresh-icon');

        button.classList.add('btn-loading');
        button.disabled = true;
        icon.style.animation = 'spin 0.5s linear';

        // Reload the page to get fresh data
        setTimeout(() => {
            window.location.reload();
        }, 500);
    }

    // Auto-refresh when page becomes visible (user comes back to tab)
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            // Page is now visible, refresh after a short delay
            setTimeout(() => {
                const status = document.getElementById('activity-status');
                if (status) {
                    status.textContent = 'Syncing...';
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                }
            }, 1000);
        }
    });

    // Add professional animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card-glass {
            animation: fadeInUp 0.6s ease-out forwards;
            opacity: 0;
        }

        .insights-section .card-glass:nth-child(1) { animation-delay: 0.1s; }
        .insights-section .card-glass:nth-child(2) { animation-delay: 0.2s; }
        .insights-section .card-glass:nth-child(3) { animation-delay: 0.3s; }
        .insights-section .card-glass:nth-child(4) { animation-delay: 0.4s; }

        .counter {
            font-variant-numeric: tabular-nums;
        }
    `;
    document.head.appendChild(style);

    // Add click ripple effect to buttons
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('btn')) {
            const ripple = document.createElement('span');
            ripple.style.position = 'absolute';
            ripple.style.borderRadius = '50%';
            ripple.style.background = 'rgba(255, 255, 255, 0.3)';
            ripple.style.transform = 'scale(0)';
            ripple.style.animation = 'ripple 0.6s linear';
            ripple.style.left = (e.offsetX - 10) + 'px';
            ripple.style.top = (e.offsetY - 10) + 'px';
            ripple.style.width = '20px';
            ripple.style.height = '20px';

            e.target.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);
        }
    });

    // Add ripple animation
    const rippleStyle = document.createElement('style');
    rippleStyle.textContent = `
        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(rippleStyle);
</script>
{% endblock %}
